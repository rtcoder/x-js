{"version":3,"file":"index.umd.js","sources":["../src/bindings.ts","../src/virtual-dom.ts","../src/main.ts"],"sourcesContent":["export type Binding = {\n  path: string,\n  placeholder: string,\n};\nexport type Bindings = Binding[];\n\nexport function getBindings(element:HTMLElement): Bindings {\n  const textBindings = getBindingsForText(element.textContent);\n  if(element.nodeType === Node.TEXT_NODE) {\n    return textBindings;\n  }\n  const attributeBindings=[];\n  const xModel = element.getAttribute('@model');\n  if(xModel) {\n    attributeBindings.push({path: xModel, placeholder: xModel});\n  }\n  return [...textBindings, ...attributeBindings];\n}\nexport function getBindingsForText(content: string | null): Bindings {\n  if (!content) {\n    return [];\n  }\n  const matches = Array.from(content.matchAll(/\\{\\s*([\\w.]+)\\s*\\}/g));\n  return matches.map((match) => ({\n    path: match[1].trim(),\n    placeholder: match[0],\n  }));\n}\n","import {getBindings, getBindingsForText} from './bindings.ts';\nimport {MixedObject} from './types/mixed-object.ts';\nimport {VNode} from './types/v-node.ts';\n\nfunction getChildren(element: HTMLElement): VNode[] {\n  return Array.from(element.childNodes).map((child) => {\n    if (child.nodeType === Node.ELEMENT_NODE) {\n      return createVirtualDOM(child as HTMLElement);\n    } else if (child.nodeType === Node.TEXT_NODE) {\n      return {\n        type: 'text',\n        content: child.textContent,\n        props: {},\n        children: [],\n        element: child,\n        bindPathList: getBindingsForText(child.textContent),\n      };\n    }\n  }).filter(Boolean) as VNode[];\n}\n\nexport function createVirtualDOM(element: HTMLElement): VNode {\n  const type = element.tagName.toLowerCase();\n  const props: MixedObject = {};\n  const content = element.textContent;\n\n  Array.from(element.attributes).forEach((attr) => {\n    props[attr.name] = attr.value;\n  });\n\n  const children = getChildren(element);\n  const bindings = element.childNodes.length ? [] : getBindings(element);\n  return {type, props, children, content, element, bindPathList: bindings};\n}\n","import {VNode} from './types/v-node.ts';\nimport {XInstanceData} from './types/x-instance-data.ts';\nimport {createVirtualDOM} from './virtual-dom.ts';\n\nfunction createReactiveModel(model: any, onChange: (path: string) => void): any {\n  function createProxy(obj: any, path: string[] = []): any {\n    return new Proxy(obj, {\n      get(target, key) {\n        const value = target[key];\n        if (typeof value === 'object' && value !== null) {\n          return createProxy(value, [...path, key as string]);\n        }\n        return value;\n      },\n      set(target, key, value) {\n        console.log('Model changed at:', [...path, key as string].join('.'), 'New value:', value);\n        target[key] = value;\n        onChange([...path, key as string].join('.'));\n        return true;\n      },\n    });\n  }\n\n  return createProxy(model);\n}\n\nfunction updateHTML(root: HTMLElement, vDom: VNode, model: any, path: string): void {\n  vDom.children.forEach((childVNode, index) => {\n    if (childVNode.children.length) {\n      updateHTML(root, childVNode, model, path);\n    }\n    if (childVNode.props['@model'] === path) {\n      const value = path.split('.').reduce((obj, key) => obj[key], model);\n      if (childVNode.element.tagName === 'INPUT') {\n        const input = childVNode.element as HTMLInputElement;\n        if (input.value !== value) {\n          input.value = value;\n        }\n      } else {\n        childVNode.element.textContent = value;\n      }\n      return;\n    }\n    if (!childVNode.bindPathList.length) {\n      return;\n    }\n\n    const foundBindings = childVNode.bindPathList.filter((bindPath) => bindPath.path === path);\n    if (!foundBindings.length) {\n      return;\n    }\n    let newContent = childVNode.content || '';\n    childVNode.bindPathList.forEach((binding) => {\n      const value = binding.path.split('.').reduce((obj, key) => obj[key], model);\n      newContent = newContent!.replace(binding.placeholder, value ?? '');\n    });\n    childVNode.element.textContent = newContent;\n  });\n\n\n}\n\nfunction bindXModel(element: HTMLElement, model: any, path: string): void {\n  const target = path.split('.').reduce((obj, key) => obj[key], model);\n\n  if (element.tagName === 'INPUT') {\n    const input = element as HTMLInputElement;\n\n    // Ustaw wartość początkową\n    input.value = target;\n\n    // Zdarzenie na zmianę wartości\n    input.addEventListener('input', (e) => {\n      const newValue = (e.target as HTMLInputElement).value;\n      const keys = path.split('.');\n      const lastKey = keys.pop()!;\n      const targetObject = keys.reduce((obj, key) => obj[key], model);\n      targetObject[lastKey] = newValue; // To wywoła Proxy\n    });\n  } else {\n    // Ustaw tekst początkowy\n    console.log({target});\n    element.textContent = target;\n  }\n\n  // Dodaj atrybut do identyfikacji elementu podczas aktualizacji\n  element.setAttribute('data-bind-path', path);\n}\n\nfunction bindClick(element: HTMLElement, model: any): void {\n  const clickHandler = element.getAttribute('@click');\n  if (clickHandler) {\n    const fn = new Function('model', `with(model) { ${clickHandler} }`);\n    element.addEventListener('click', () => fn(model));\n  }\n}\n\nfunction bindPlaceholdersUsingVirtualDOM(vNode: VNode, model: any): void {\n  const {content, props, element, bindPathList} = vNode;\n  console.log('element', element);\n  if (content && content.includes('{') && content.includes('}') && element.nodeType === Node.TEXT_NODE) {\n\n    const updateText = () => {\n      let updatedText = content;\n      bindPathList.forEach(({path, placeholder}) => {\n        const value = path.split('.').reduce((obj, key) => obj[key], model);\n        updatedText = updatedText.replace(placeholder, value ?? '');\n      });\n      element.textContent = updatedText;\n    };\n\n    updateText();\n\n    // Odświeżanie tekstu na zmianę modelu\n    bindPathList.forEach(({path}) => {\n      createReactiveModel(model, (updatedPath) => {\n        if (updatedPath.startsWith(path.split('.')[0])) {\n          updateText();\n        }\n      });\n    });\n  }\n\n  // Przetwarzaj dzieci rekurencyjnie\n  vNode.children.forEach((childVNode) => {\n    if (typeof childVNode === 'object') {\n      bindPlaceholdersUsingVirtualDOM(childVNode, model);\n    }\n  });\n}\n\n/**\n * Inicjalizuje aplikację z wykorzystaniem Virtual DOM\n * @param {XInstanceData} instanceData\n */\nexport function initializeAppWithVirtualDOM(instanceData: XInstanceData): void {\n  const {container, data: model} = instanceData;\n  const root = typeof container === 'string'\n    ? document.querySelector(container) as HTMLElement\n    : container;\n\n  const virtualDOM = createVirtualDOM(root);\n\n  console.log(virtualDOM);\n\n  const reactiveModel = createReactiveModel(model, (path) => {\n    updateHTML(root, virtualDOM, reactiveModel, path);\n  });\n\n  function processVNode(vNode: VNode, parentElement: HTMLElement): void {\n    if (vNode.props['@model']) {\n      bindXModel(parentElement, reactiveModel, vNode.props['@model']);\n    }\n\n    if (vNode.props['@click']) {\n      bindClick(parentElement, reactiveModel);\n    }\n\n    bindPlaceholdersUsingVirtualDOM(vNode, reactiveModel);\n\n    vNode.children.forEach((childVNode, index) => {\n      if (typeof childVNode === 'object') {\n        const childElement = parentElement.childNodes[index] as HTMLElement;\n        processVNode(childVNode, childElement);\n      }\n    });\n  }\n\n  processVNode(virtualDOM, root);\n}\n\n"],"names":["getBindings","element","textBindings","getBindingsForText","attributeBindings","xModel","content","match","getChildren","child","createVirtualDOM","type","props","attr","children","bindings","createReactiveModel","model","onChange","createProxy","obj","path","target","key","value","updateHTML","root","vDom","childVNode","index","input","bindPath","newContent","binding","bindXModel","e","newValue","keys","lastKey","targetObject","bindClick","clickHandler","fn","bindPlaceholdersUsingVirtualDOM","vNode","bindPathList","updateText","updatedText","placeholder","updatedPath","initializeAppWithVirtualDOM","instanceData","container","virtualDOM","reactiveModel","processVNode","parentElement","childElement"],"mappings":"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"}
