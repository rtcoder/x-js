{"version":3,"file":"index.es.js","sources":["../src/main.ts"],"sourcesContent":["type MixedObject = {\n  [key: string]: any;\n}\ntype XInstanceData = {\n  container: HTMLElement | string;\n  data: MixedObject;\n  methods?: MixedObject;\n}\ntype Binding = {\n  path: string,\n  placeholder: string,\n};\ntype Bindings = Binding[];\ntype VNode = {\n  type: string;\n  props: MixedObject;\n  content: string | null;\n  children: VNode[];\n  element: HTMLElement;\n  bindPathList: Bindings;\n}\nconst MODEL_PROP = '@model';\nconst CLICK_PROP = '@click';\nconst IF_PROP = '@if';\n\nfunction getBindings(element: HTMLElement): Bindings {\n  const textBindings = getBindingsForText(element.textContent);\n  if (element.nodeType === Node.TEXT_NODE) {\n    return textBindings;\n  }\n  const attributeBindings = [];\n  const xModel = element.getAttribute(MODEL_PROP);\n  if (xModel) {\n    attributeBindings.push({path: xModel, placeholder: xModel});\n  }\n  return [...textBindings, ...attributeBindings];\n}\n\nfunction getBindingsForText(content: string | null): Bindings {\n  if (!content) {\n    return [];\n  }\n  const matches = Array.from(content.matchAll(/\\{\\s*([\\w.]+)\\s*\\}/g));\n  return matches.map((match) => ({\n    path: match[1].trim(),\n    placeholder: match[0],\n  }));\n}\n\nfunction getChildren(element: HTMLElement): VNode[] {\n  return Array.from(element.childNodes).map((child) => {\n    if (child.nodeType === Node.ELEMENT_NODE) {\n      return createVirtualDOM(child as HTMLElement);\n    } else if (child.nodeType === Node.TEXT_NODE) {\n      return {\n        type: 'text',\n        content: child.textContent,\n        props: {},\n        children: [],\n        element: child,\n        bindPathList: getBindingsForText(child.textContent),\n      };\n    } else if (child.nodeType === Node.COMMENT_NODE) {\n      return {\n        type: 'comment',\n        content: child.textContent,\n        props: {},\n        children: [],\n        element: child,\n        bindPathList: getBindingsForText(child.textContent),\n      };\n    }\n  }).filter(Boolean) as VNode[];\n}\n\n function createVirtualDOM(element: HTMLElement): VNode {\n  const type = element.tagName.toLowerCase();\n  const props: MixedObject = {};\n  const content = element.textContent;\n\n  Array.from(element.attributes).forEach((attr) => {\n    props[attr.name] = attr.value;\n  });\n\n  const children = getChildren(element);\n  const bindings = element.childNodes.length ? [] : getBindings(element);\n  return {type, props, children, content, element, bindPathList: bindings};\n}\n\nfunction createReactiveModel(model: any, onChange: (path: string) => void): any {\n  function createProxy(obj: any, path: string[] = []): any {\n    return new Proxy(obj, {\n      get(target, key) {\n        const value = target[key];\n        if (typeof value === 'object' && value !== null) {\n          return createProxy(value, [...path, key as string]);\n        }\n        return value;\n      },\n      set(target, key, value) {\n        console.log('Model changed at:', [...path, key as string].join('.'), 'New value:', value);\n        target[key] = value;\n        onChange([...path, key as string].join('.'));\n        return true;\n      },\n    });\n  }\n\n  return createProxy(model);\n}\n\nfunction updateHTML(root: HTMLElement, vDom: VNode, model: any, path: string): void {\n  vDom.children.forEach((childVNode, index) => {\n    if (childVNode.props[IF_PROP]) {\n      const condition = childVNode.props[IF_PROP];\n      const isVisible = new Function('model', `with(model) { return ${condition}; }`)(model);\n\n      if (!isVisible) {\n        childVNode.element.style.display = 'none';\n        return;\n      } else {\n        childVNode.element.style.display = '';\n      }\n    }\n    if (childVNode.children.length) {\n      updateHTML(root, childVNode, model, path);\n    }\n    if (childVNode.props[MODEL_PROP] === path) {\n      const value = path.split('.').reduce((obj, key) => obj[key], model);\n      if (childVNode.element.tagName === 'INPUT') {\n        const input = childVNode.element as HTMLInputElement;\n        if (input.value !== value) {\n          input.value = value;\n        }\n      } else {\n        childVNode.element.textContent = value;\n      }\n      return;\n    }\n    if (!childVNode.bindPathList.length) {\n      return;\n    }\n\n    const foundBindings = childVNode.bindPathList.filter((bindPath) => bindPath.path === path);\n    if (!foundBindings.length) {\n      return;\n    }\n    let newContent = childVNode.content || '';\n    childVNode.bindPathList.forEach((binding) => {\n      const value = binding.path.split('.').reduce((obj, key) => obj[key], model);\n      newContent = newContent!.replace(binding.placeholder, value ?? '');\n    });\n    childVNode.element.textContent = newContent;\n  });\n}\n\nfunction bindXModel(element: HTMLElement, model: any, path: string): void {\n  const target = path.split('.').reduce((obj, key) => obj[key], model);\n\n  if (element.tagName === 'INPUT') {\n    const input = element as HTMLInputElement;\n\n    // Ustaw wartość początkową\n    input.value = target;\n\n    // Zdarzenie na zmianę wartości\n    input.addEventListener('input', (e) => {\n      const newValue = (e.target as HTMLInputElement).value;\n      const keys = path.split('.');\n      const lastKey = keys.pop()!;\n      const targetObject = keys.reduce((obj, key) => obj[key], model);\n      targetObject[lastKey] = newValue; // To wywoła Proxy\n    });\n  } else {\n    // Ustaw tekst początkowy\n    console.log({target});\n    element.textContent = target;\n  }\n}\n\nfunction bindClick(element: HTMLElement, model: any): void {\n  const clickHandler = element.getAttribute(CLICK_PROP);\n  if (clickHandler) {\n    const fn = new Function('model', `with(model) { ${clickHandler} }`);\n    element.addEventListener('click', () => fn(model));\n  }\n}\n\nfunction bindPlaceholdersUsingVirtualDOM(vNode: VNode, model: any): void {\n  const {content, props, element, bindPathList} = vNode;\n  console.log('element', element);\n  if (content && content.includes('{') && content.includes('}') && element.nodeType === Node.TEXT_NODE) {\n\n    const updateText = () => {\n      let updatedText = content;\n      bindPathList.forEach(({path, placeholder}) => {\n        const value = path.split('.').reduce((obj, key) => obj[key], model);\n        updatedText = updatedText.replace(placeholder, value ?? '');\n      });\n      element.textContent = updatedText;\n    };\n\n    updateText();\n\n    // Odświeżanie tekstu na zmianę modelu\n    bindPathList.forEach(({path}) => {\n      createReactiveModel(model, (updatedPath) => {\n        if (updatedPath.startsWith(path.split('.')[0])) {\n          updateText();\n        }\n      });\n    });\n  }\n\n  // Przetwarzaj dzieci rekurencyjnie\n  vNode.children.forEach((childVNode) => {\n    if (typeof childVNode === 'object') {\n      bindPlaceholdersUsingVirtualDOM(childVNode, model);\n    }\n  });\n}\n\nexport function initializeAppWithVirtualDOM(instanceData: XInstanceData): void {\n  const {container, data: model} = instanceData;\n  const root = typeof container === 'string'\n    ? document.querySelector(container) as HTMLElement\n    : container;\n\n  const virtualDOM = createVirtualDOM(root);\n\n  console.log(virtualDOM);\n\n  const reactiveModel = createReactiveModel(model, (path) => {\n    updateHTML(root, virtualDOM, reactiveModel, path);\n  });\n\n  function processVNode(vNode: VNode, parentElement: HTMLElement): void {\n    const {props, element} = vNode;\n    // Obsługa @if\n    if (props[IF_PROP]) {\n      const condition = props[IF_PROP];\n      const isVisible = new Function('model', `with(model) { return ${condition}; }`)(model);\n\n      if (!isVisible) {\n        element.style.display = 'none';\n        return;\n      } else {\n        element.style.display = '';\n      }\n    }\n    if (props[MODEL_PROP]) {\n      bindXModel(parentElement, reactiveModel, props[MODEL_PROP]);\n    }\n\n    if (props[CLICK_PROP]) {\n      bindClick(parentElement, reactiveModel);\n    }\n\n    bindPlaceholdersUsingVirtualDOM(vNode, reactiveModel);\n\n    vNode.children.forEach((childVNode, index) => {\n      if (typeof childVNode === 'object') {\n        console.log(parentElement)\n        const childElement = parentElement.childNodes[index] as HTMLElement;\n        console.log(childElement,childVNode);\n        processVNode(childVNode, childElement);\n      }\n    });\n  }\n\n\n  processVNode(virtualDOM, root);\n}\n\n"],"names":["MODEL_PROP","CLICK_PROP","IF_PROP","getBindings","element","textBindings","getBindingsForText","attributeBindings","xModel","content","match","getChildren","child","createVirtualDOM","type","props","attr","children","bindings","createReactiveModel","model","onChange","createProxy","obj","path","target","key","value","updateHTML","root","vDom","childVNode","index","condition","input","bindPath","newContent","binding","bindXModel","e","newValue","keys","lastKey","targetObject","bindClick","clickHandler","fn","bindPlaceholdersUsingVirtualDOM","vNode","bindPathList","updateText","updatedText","placeholder","updatedPath","initializeAppWithVirtualDOM","instanceData","container","virtualDOM","reactiveModel","processVNode","parentElement","childElement"],"mappings":"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"}